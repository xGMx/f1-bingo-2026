<!doctype html>
<html lang="it" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>F1 Bingo 2026</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    .font-orbitron { font-family: 'Orbitron', monospace; }
    .font-rajdhani { font-family: 'Rajdhani', sans-serif; }
    body { box-sizing: border-box; }
  </style>
</head>

<body class="h-full m-0 p-0 overflow-auto" style="background:#1a1a2e;">

  <!-- DELETE CONFIRMATION MODAL -->
  <div id="delete-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-lg p-6 max-w-sm w-full" style="background:#16213e;border:2px solid #E10600;">
      <h2 class="font-orbitron text-2xl font-bold text-white mb-4">Conferma Eliminazione</h2>
      <p class="font-rajdhani text-white mb-6">Sei sicuro di voler eliminare questo giocatore?</p>
      <div class="flex gap-3">
        <button id="confirm-delete-btn" class="flex-1 px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#E10600;">Elimina</button>
        <button id="cancel-delete-btn" class="flex-1 px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#2d3748;">Annulla</button>
      </div>
    </div>
  </div>

  <!-- LOCK CONFIRMATION MODAL -->
  <div id="lock-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-lg p-6 max-w-sm w-full" style="background:#16213e;border:2px solid #E10600;">
      <h2 class="font-orbitron text-2xl font-bold text-white mb-4">Blocca Scelte</h2>
      <p class="font-rajdhani text-white mb-6">Vuoi bloccare queste 25 caselle per questa gara?</p>
      <div class="flex gap-3">
        <button id="confirm-lock-btn" class="flex-1 px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#E10600;">Blocca</button>
        <button id="cancel-lock-btn" class="flex-1 px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#2d3748;">Annulla</button>
      </div>
    </div>
  </div>

  <!-- BINGO MODAL -->
  <div id="bingo-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-lg p-8 max-w-sm w-full text-center" style="background:#16213e;border:3px solid #E10600;">
      <p class="text-5xl mb-4">BINGO!</p>
      <h2 class="font-orbitron text-3xl font-bold text-white mb-2" style="color:#E10600;">HAI VINTO</h2>
      <p class="font-rajdhani text-white mb-6">Hai completato una linea vincente!</p>
      <button id="close-bingo-btn" class="w-full px-6 py-3 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#E10600;">Ok</button>
    </div>
  </div>

  <!-- RESET SEASON MODAL -->
  <div id="reset-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-lg p-6 max-w-sm w-full" style="background:#16213e;border:2px solid #E10600;">
      <h2 class="font-orbitron text-2xl font-bold text-white mb-4">Conferma Reset</h2>
      <p class="font-rajdhani text-white mb-6">Eliminare tutti i giocatori?</p>
      <div class="flex gap-3">
        <button id="confirm-reset-btn" class="flex-1 px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#E10600;">Reset</button>
        <button id="cancel-reset-btn" class="flex-1 px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#2d3748;">Annulla</button>
      </div>
    </div>
  </div>

  <!-- NOTIFICATION MODAL -->
  <div id="notify-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-lg p-6 max-w-sm w-full text-center" style="background:#16213e;border:2px solid #E10600;">
      <p id="notify-message" class="font-rajdhani text-white text-lg mb-6"></p>
      <button id="close-notify-btn" class="w-full px-6 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#E10600;">Ok</button>
    </div>
  </div>

  <!-- EVENT SELECTION MODAL -->
  <div id="modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4 overflow-auto">
    <div class="bg-gray-900 rounded-lg p-6 max-w-5xl w-full" style="background:#16213e;border:2px solid #E10600;">
      <h2 class="font-orbitron text-3xl font-bold text-white mb-4">Scegli 24 Eventi</h2>
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
        <div class="lg:col-span-3">
          <div id="category-tabs" class="flex flex-wrap gap-2 mb-4"></div>
          <div class="max-h-96 overflow-y-auto" id="events-container" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;align-content:start;"></div>
        </div>
        <div style="background:#1a1a2e;" class="p-4 rounded-lg h-fit flex flex-col justify-between">
          <p class="font-orbitron text-white font-bold mb-6">Selezionati: <span id="counter">0</span>/24</p>
          <button id="random-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white mb-3 transition-all hover:scale-105" style="background:#444;">Casuale</button>
          <button id="next-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white" style="background:#E10600;opacity:.5;cursor:not-allowed;" disabled>Avanti</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CENTER CELL SELECTION MODAL -->
  <div id="center-modal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4 overflow-auto">
    <div class="bg-gray-900 rounded-lg p-6 max-w-4xl w-full" style="background:#16213e;border:2px solid #E10600;">
      <h2 class="font-orbitron text-3xl font-bold text-white mb-4">Scegli la Casella Centrale</h2>
      <p class="font-rajdhani text-white mb-6 text-center">Seleziona l'evento per la casella centrale - varr√† il doppio!</p>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <div class="lg:col-span-2 max-h-96 overflow-y-auto" id="center-events-container" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;align-content:start;"></div>
        <div style="background:#1a1a2e;" class="p-4 rounded-lg h-fit flex flex-col justify-between">
          <p class="font-orbitron text-white font-bold mb-6">Selezionato: <span id="center-counter">0</span>/1</p>
          <button id="back-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white mb-3 transition-all hover:scale-105" style="background:#444;">Indietro</button>
          <button id="play-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white" style="background:#E10600;opacity:.5;cursor:not-allowed;" disabled>Gioca!</button>
        </div>
      </div>
    </div>
  </div>

  <div class="w-full flex flex-col lg:flex-row gap-6 p-8 min-h-full">
    <!-- LEFT SIDEBAR: CLASSIFICA -->
    <aside class="lg:w-80 w-full">
      <div class="rounded-lg p-6 sticky top-8" style="background:#16213e;border:2px solid #E10600;">
        <h2 class="font-orbitron text-2xl font-bold text-white mb-4"><span style="color:#E10600;">CLASSIFICA</span></h2>

        <!-- Game Selection -->
        <div class="mb-6 p-4 rounded-lg" style="background:#1a1a2e;border:1px solid #E10600;">
          <p class="font-rajdhani text-sm text-white mb-2 font-bold">Scegli la gara</p>
          <select id="race-selector" class="w-full px-3 py-2 rounded font-rajdhani text-sm mb-4" style="background:#2d3748;color:#fff;border:2px solid #444;"></select>

          <p class="font-rajdhani text-sm text-white mb-2 font-bold">Scegli il tuo nome</p>
          <select id="player-selector" class="w-full px-3 py-2 rounded font-rajdhani text-sm mb-3" style="background:#2d3748;color:#fff;border:2px solid #444;" disabled></select>

          <button id="start-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white text-sm transition-all hover:scale-105" style="background:#E10600;opacity:.5;cursor:not-allowed;" disabled>Inizia Partita</button>
        </div>

        <!-- Add Player -->
        <div class="mb-6 p-4 rounded-lg" style="background:#1a1a2e;border:1px solid #E10600;">
          <input type="text" id="new-player-name" placeholder="Nome giocatore" class="w-full px-3 py-2 rounded font-rajdhani text-sm mb-2" style="background:#2d3748;color:#fff;border:2px solid #444;">
          <button id="add-player-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#E10600;">+ Aggiungi Giocatore</button>
        </div>

        <!-- Players List -->
        <div id="leaderboard" class="space-y-2 max-h-64 overflow-y-auto mb-4"></div>

        <!-- Mini Podium -->
        <div class="mb-4 p-4 rounded-lg" style="background:#1a1a2e;border:2px solid #E10600;">
          <p class="font-orbitron text-sm font-bold text-white mb-3 text-center" style="color:#E10600;">PODIO</p>
          <div id="podium-container" style="display:flex;align-items:flex-end;justify-content:center;gap:8px;height:200px;width:100%;"></div>
        </div>

        <button id="reset-season-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white text-xs transition-all hover:scale-105" style="background:#2d3748;border:1px solid #666;">Reset Stagione</button>
      </div>
    </aside>

    <!-- CENTER: MAIN GAME -->
    <main class="flex-1">
      <div class="text-center mb-8">
        <h1 class="font-orbitron text-5xl font-black text-white mb-2" style="color:#E10600;">F1 BINGO 2026</h1>
      </div>

      <div id="game-container" class="hidden w-full">
        <p id="player-display" class="font-orbitron text-xl font-bold text-white mb-4 text-center" style="color:#E10600;"></p>
        <p id="race-title" class="font-orbitron text-2xl font-bold text-white mb-4 text-center"></p>
        <p id="lock-status" class="font-rajdhani text-center mb-4 text-sm font-bold"></p>

        <div id="bingo-grid" class="grid grid-cols-5 gap-3 mb-6" style="max-width:600px;margin:0 auto;"></div>

        <div class="text-center mb-6">
          <p class="font-rajdhani text-white mb-4">Caselle segnate: <span id="score">0</span>/25</p>
          <button id="toggle-lock-btn" class="px-6 py-2 rounded font-rajdhani font-bold text-white mr-2 transition-all hover:scale-105" style="background:#FFA500;">Blocca Scelte</button>
          <button id="toggle-unlock-btn" class="px-6 py-2 rounded font-rajdhani font-bold text-white mr-2 transition-all hover:scale-105" style="background:#FF6B6B;display:none;">Sblocca Scelte</button>
          <button id="new-game-btn" class="px-6 py-2 rounded font-rajdhani font-bold text-white" style="background:#2d3748;">Modifica Scelte</button>
        </div>

        <div id="other-players-container" class="w-full"></div>
      </div>
    </main>

    <!-- RIGHT SIDEBAR -->
    <aside class="lg:w-80 w-full flex flex-col gap-6">
      <div id="race-scores-container" class="rounded-lg p-6" style="background:#16213e;border:2px solid #E10600;display:none;">
        <p class="font-orbitron text-lg font-bold text-white mb-4 text-center" style="color:#E10600;">PUNTEGGI GARA</p>
        <div id="race-scores-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
      </div>

      <div id="lock-status-container" class="rounded-lg p-6" style="background:#16213e;border:2px solid #E10600;display:none;">
        <p class="font-orbitron text-lg font-bold text-white mb-4 text-center" style="color:#E10600;">STATUS BLOCCO</p>
        <div id="locks-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
      </div>

      <div class="rounded-lg p-6" style="background:#16213e;border:2px solid #E10600;">
        <p class="font-orbitron text-lg font-bold text-white mb-4 text-center" style="color:#E10600;">PUNTEGGIO</p>
        <div class="space-y-2 font-rajdhani text-xs text-white">
          <div class="flex justify-between items-start p-2 rounded" style="background:#2d3748;"><span>Ogni casella</span><span style="color:#ffd700;font-weight:bold;">1 pt</span></div>
          <div class="flex justify-between items-start p-2 rounded" style="background:#2d3748;"><span>Primo BINGO</span><span style="color:#ffd700;font-weight:bold;">+20 pt</span></div>
          <div class="flex justify-between items-start p-2 rounded" style="background:#2d3748;"><span>Linea extra</span><span style="color:#ffd700;font-weight:bold;">+10 pt</span></div>
          <div class="flex justify-between items-start p-2 rounded" style="background:#2d3748;"><span>Blackout (25/25)</span><span style="color:#ffd700;font-weight:bold;">+50 pt</span></div>
          <div class="flex justify-between items-start p-2 rounded" style="background:#2d3748;"><span>The X (diagonali)</span><span style="color:#ffd700;font-weight:bold;">+15 pt</span></div>
          <div class="flex justify-between items-start p-2 rounded" style="background:#2d3748;"><span>4 Angoli</span><span style="color:#ffd700;font-weight:bold;">+10 pt</span></div>
          <div class="flex justify-between items-start p-2 rounded" style="background:#2d3748;"><span>Casella centrale</span><span style="color:#ffd700;font-weight:bold;">2x punti</span></div>
        </div>
      </div>

      <div id="race-events-container" class="rounded-lg p-6" style="background:#16213e;border:2px solid #E10600;display:none;">
        <p class="font-orbitron text-lg font-bold text-white mb-4 text-center" style="color:#E10600;">EVENTI GARA</p>
        <div id="events-mode-display" class="mb-4 text-center font-rajdhani text-sm text-white"></div>
        <div id="race-events-list" class="space-y-2 max-h-56 overflow-y-auto mb-4"></div>
        <button id="submit-results-btn" class="w-full px-4 py-2 rounded font-rajdhani font-bold text-white transition-all hover:scale-105" style="background:#E10600;">Invia Risultati</button>
      </div>
    </aside>
  </div>

<script>
/* =========================
   LOCAL STORAGE (NO BACKEND)
   ========================= */
const STORAGE_KEY = "f1_bingo_2026_state_v1";

function uid() {
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function defaultState() {
  return {
    players: []
  };
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return defaultState();
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== "object" || !Array.isArray(parsed.players)) return defaultState();
    return parsed;
  } catch {
    return defaultState();
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
}

function notify(msg) {
  document.getElementById('notify-message').textContent = msg;
  document.getElementById('notify-modal').classList.remove('hidden');
}

let appState = loadState();

/* Player schema
player = {
  id, player_name,
  total_points: number,
  race_locks: { race_1: true/false, ... },
  race_results: { race_results_1: [eventIndex,...], ... },
  races: {
    race_1: { points, bingo, events:[25], marked_indices:[...], centerChoice? },
    ...
  }
}
*/

function getPlayerById(id) {
  return appState.players.find(p => p.id === id) || null;
}

function deletePlayerById(id) {
  appState.players = appState.players.filter(p => p.id !== id);
  saveState();
}

/* =========================
   EVENTS & RACES
   ========================= */
const eventCategories = {
  "Azione in Pista e Incidenti": [
    "Contatto alla prima curva",
    "Contatto al primo giro",
    "Due DNF alla prima curva",
    "Sorpasso al via",
    "Sorpasso all'ultimo giro",
    "Sorpasso della gara",
    "Sorpasso all'esterno in una curva veloce",
    "Sorpasso triplo sul rettilineo",
    "Tre piloti affiancati in frenata",
    "Qualifiche bagnate",
    "Qualifica sospesa causa incidente",
    "Q1, Q2 o Q3 sospeso a causa di bandiera rossa",
    "Testacoda senza danni",
    "Testacoda nel giro di formazione",
    "Un pilota va lungo e usa la via di fuga",
    "Un pilota bacia il muro ma continua la corsa",
    "Battaglia tra compagni di squadra",
    "Contatto tra compagni di squadra",
    "5 Bloccaggi dell'anteriore con fumo bianco",
    "Trenino DRS (4-5 auto in fila)",
    "Foratura improvvisa",
    "Detriti in pista",
    "Oggetto in pista",
    "Pioggia durante la gara"
  ],
  "Tecnica, Box e Strategia": [
    "Pit stop sotto i 2 secondi",
    "Pit stop lento",
    "Doppio pit stop",
    "Errore ai box",
    "Pilota che sbaglia la piazzola",
    "Cambio ala anteriore",
    "Ali anteriori danneggiate",
    "Strategia vincente",
    "Strategia sbagliata del muretto",
    "Strategia estrema con una sosta ritardatissima",
    "Problema al motore (fumo)",
    "Ritiro per problema motore I lost power",
    "Surriscaldamento freni o motore",
    "Pilota che chiede il Plan B o Plan C",
    "Pilota che ignora la chiamata al box",
    "Due auto si toccano in Pit lane"
  ],
  "Direzione Gara e Penalit√†": [
    "Bandiera rossa",
    "Safety Car",
    "Virtual Safety Car (VSC)",
    "Gara che finisce sotto Safety Car",
    "Investigazione per Unsafe Release",
    "3 Track limits superati",
    "Penalit√† di 5 secondi",
    "Penalit√† di 10 secondi",
    "Penalit√† di 15 secondi",
    "Penalit√† Drive-through",
    "Penalit√† per impeding",
    "Bandiera bianco-nera",
    "Bandiera Blu ignorata",
    "Jump Start",
    "Pilota che sbaglia la procedura di partenza",
    "Rookie che causa bandiera rossa"
  ],
  "Radio e Comunicazioni": [
    "Team radio arrabbiato",
    "Team Radio con Bip (censurato)",
    "Pilota che si lamenta delle gomme My tires are dead",
    "Il pilota chiede silenzio all'ingegnere Leave me to it",
    "Ringraziamento al team in lingua madre",
    "Commentatore che urla per un sorpasso",
    "Messaggio di incoraggiamento del padre di un pilota",
    "Team radio dove si lamentano di altri team",
    "Urlo in radio",
    "Bip in radio dopo ritiro",
    "Commento ironico sulle prestazioni della macchina",
    "Il pilota canta in radio"
  ],
  "Regia e Paddock": [
    "Inquadratura di una celebrit√†",
    "VIP che sventola la bandiera",
    "Inquadratura di Toto Wolff arrabbiato",
    "Inquadratura di un animale in pista",
    "Inquadratura della fidanzata/moglie preoccupata",
    "Meccanico che scuote la testa ai box",
    "Team Principal che esulta",
    "Pilota che guarda il monitor ai box dopo un ritiro",
    "Selfie sul podio",
    "Cambio di casco speciale",
    "Replay di un sorpasso storico",
    "Commentatore che urla per un sorpasso"
  ],
  "Vincita di una Vettura": [
    "Vittoria di una vettura Ferrari",
    "Vittoria di una vettura McLaren",
    "Vittoria di una vettura Mercedes",
    "Vittoria di una vettura Williams",
    "Vittoria di una vettura Red Bull",
    "Vittoria di una vettura Aston Martin",
    "Vittoria di una vettura Haas",
    "Vittoria di una vettura Audi",
    "Vittoria di una vettura Cadillac",
    "Vittoria di una vettura RB Visa Card",
    "Vittoria di una vettura Alpine",
  ],
  "Risultati e Statistiche": [
    "Prima vittoria di Lewis in Ferrari",
    "Pole e Vittoria dello stesso pilota",
    "Chi fa la Pole finisce P4",
    "Chi parte dopo la P3 vince la gara",
    "Doppietta di un solo team",
    "Podio con tre scuderie diverse",
    "Podio con tutti piloti inglesi",
    "Rookie sul podio",
    "Giro veloce stabilito all'ultimo giro",
    "Distacco sotto i 0.100 secondi al traguardo tra il primo e secondo",
    "Distacco sopra i 20 secondi al traguardo tra il primo e secondo",
    "Rimonta di almeno 10 posizioni",
    "Leader che doppia il compagno di squadra",
    "Leader doppia tutti tranne i piloti sul podio",
  ],
  "La gara finisce con‚Ä¶": [
    "La gara finisce con tutte le macchine",
    "La gara finisce con 21 macchine",
    "La gara finisce con 20 macchine",
    "La gara finisce con 19 macchine",
    "La gara finisce con 18 macchine",
    "La gara finisce con 17 macchine",
    "La gara finisce con 16 macchine",
    "La gara finisce con 15 macchine",
    "La gara finisce con 14 macchine",
    "La gara finisce con 13 macchine",
    "La gara finisce con 12 macchine",
    "La gara finisce con 11 macchine",
    "La gara finisce con 10 macchine",
  ],
  "Driver of the Day‚Ä¶": [
    "Driver of the Day - Gasly",
    "Driver of the Day - Colapinto",
    "Driver of the Day - Alonso",
    "Driver of the Day - Stroll",
    "Driver of the Day - Hulkenberg",
    "Driver of the Day - Bortoleto",
    "Driver of the Day - Perez",
    "Driver of the Day - Bottas",
    "Driver of the Day - Leclerc",
    "Driver of the Day - Hamilton",
    "Driver of the Day - Ocon",
    "Driver of the Day - Bearman",
    "Driver of the Day - Norris",
    "Driver of the Day - Piastri",
    "Driver of the Day - Russell",
    "Driver of the Day - Antonelli",
    "Driver of the Day - Lawson",
    "Driver of the Day - Lindblad",
    "Driver of the Day - Verstappen",
    "Driver of the Day - Hadjar",
    "Driver of the Day - Sainz",
    "Driver of the Day - Albon"
  ]
};

const allEvents = Object.values(eventCategories).flat();

const centerCellEvents = [
  "Vittoria di Gasly",
  "Vittoria di Colapinto",
  "Vittoria di Alonso",
  "Vittoria di Stroll",
  "Vittoria di Hulkenberg",
  "Vittoria di Bortoleto",
  "Vittoria di Perez",
  "Vittoria di Bottas",
  "Vittoria di Leclerc",
  "Vittoria di Hamilton",
  "Vittoria di Ocon",
  "Vittoria di Bearman",
  "Vittoria di Norris",
  "Vittoria di Piastri",
  "Vittoria di Russell",
  "Vittoria di Antonelli",
  "Vittoria di Lawson",
  "Vittoria di Lindblad",
  "Vittoria di Verstappen",
  "Vittoria di Hadjar",
  "Vittoria di Sainz",
  "Vittoria di Albon"
];

const raceNames = [
  "1. GP Australia", "2. GP Cina", "3. GP Giappone", "4. GP Bahrain",
  "5. GP Arabia Saudita", "6. GP Miami", "7. GP Canada", "8. GP Monaco",
  "9. GP Catalunya", "10. GP Austria", "11. GP Gran Bretagna", "12. GP Belgio",
  "13. GP Ungheria", "14. GP Olanda", "15. GP Italia", "16. GP Spagna",
  "17. GP Azerbaigian", "18. GP Singapore", "19. GP Austin", "20. GP Messico",
  "21. GP Brasile", "22. GP Las Vegas", "23. GP Qatar", "24. GP Abu Dhabi"
];

/* =========================
   GAME STATE (UI runtime)
   ========================= */
let selectedIndices = new Set();
let centerCellIndex = null;
let selectedEvents = [];
let markedCells = new Set();
let bingoAchieved = false;
let currentPlayer = null;  // object reference from appState
let currentRace = null;    // number 1..24
let playerToDelete = null;
let isRaceLocked = false;
let currentCategory = null;
let selectedRaceEvents = new Set();
let resultsSubmitted = false;

/* =========================
   SCORING
   ========================= */
function calculatePoints(markedSet) {
  let points = 0;
  markedSet.forEach(idx => { points += (idx === 12 ? 2 : 1); });

  const lines = [
    [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
    [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
    [0,6,12,18,24], [4,8,12,16,20]
  ];

  let bingoCount = 0;
  lines.forEach(line => {
    if (line.every(i => markedSet.has(i))) {
      points += (bingoCount === 0 ? 20 : 10);
      bingoCount++;
    }
  });

  if (markedSet.has(0) && markedSet.has(4) && markedSet.has(20) && markedSet.has(24)) points += 10;
  if (markedSet.size === 25) points += 50;
  return points;
}

function checkBingoStatus(markedSet) {
  const lines = [
    [0,1,2,3,4], [5,6,7,8,9], [10,11,12,13,14], [15,16,17,18,19], [20,21,22,23,24],
    [0,5,10,15,20], [1,6,11,16,21], [2,7,12,17,22], [3,8,13,18,23], [4,9,14,19,24],
    [0,6,12,18,24], [4,8,12,16,20]
  ];
  return lines.some(line => line.every(i => markedSet.has(i)));
}

/* =========================
   PERSISTENCE HELPERS
   ========================= */
function ensurePlayerDefaults(p) {
  if (!p.race_locks || typeof p.race_locks !== "object") p.race_locks = {};
  if (!p.race_results || typeof p.race_results !== "object") p.race_results = {};
  if (!p.races || typeof p.races !== "object") p.races = {};
  if (typeof p.total_points !== "number") p.total_points = 0;
}

function recomputeTotalPointsForPlayer(p) {
  ensurePlayerDefaults(p);
  let total = 0;
  for (let r = 1; r <= 24; r++) {
    const rk = `race_${r}`;
    if (p.races[rk] && typeof p.races[rk].points === "number") total += p.races[rk].points;
  }
  p.total_points = total;
}

function getRaceData(player, raceNumber) {
  ensurePlayerDefaults(player);
  const key = `race_${raceNumber}`;
  return player.races[key] || null;
}

function setRaceData(player, raceNumber, data) {
  ensurePlayerDefaults(player);
  const key = `race_${raceNumber}`;
  player.races[key] = data;
  recomputeTotalPointsForPlayer(player);
  saveState();
}

function isLockedFor(player, raceNumber) {
  ensurePlayerDefaults(player);
  return !!player.race_locks[`race_${raceNumber}`];
}

function setLockFor(player, raceNumber, locked) {
  ensurePlayerDefaults(player);
  player.race_locks[`race_${raceNumber}`] = !!locked;
  saveState();
}

/* =========================
   UI RENDER
   ========================= */
function updateStartButton() {
  const startBtn = document.getElementById('start-btn');
  if (currentRace && currentPlayer) {
    startBtn.disabled = false;
    startBtn.style.opacity = '1';
    startBtn.style.cursor = 'pointer';
  } else {
    startBtn.disabled = true;
    startBtn.style.opacity = '0.5';
    startBtn.style.cursor = 'not-allowed';
  }
}

function renderLeaderboard() {
  const leaderboard = document.getElementById('leaderboard');
  leaderboard.innerHTML = '';
  const sorted = [...appState.players].map(p => (ensurePlayerDefaults(p), p))
    .sort((a,b) => (b.total_points||0) - (a.total_points||0));

  sorted.forEach(player => {
    const el = document.createElement('div');
    el.className = 'p-3 rounded-lg cursor-pointer transition-all font-rajdhani';
    const isCurrent = currentPlayer && currentPlayer.id === player.id;
    el.style.background = isCurrent ? '#E10600' : '#2d3748';
    el.style.border = `2px solid ${isCurrent ? '#E10600' : '#444'}`;

    el.innerHTML = `
      <div class="flex justify-between items-center">
        <div class="flex-1">
          <p class="text-white font-bold">${player.player_name}</p>
          <p class="text-sm" style="color:#ffd700;">* ${player.total_points || 0} punti</p>
        </div>
        <div class="flex gap-1">
          <button class="px-2 py-1 rounded text-xs font-bold text-white transition-all hover:scale-105" style="background:#444;" data-select="${player.id}">Scegli</button>
          <button class="px-2 py-1 rounded text-xs font-bold text-white bg-red-600 transition-all hover:scale-105" data-delete="${player.id}">X</button>
        </div>
      </div>
    `;
    leaderboard.appendChild(el);
  });

  leaderboard.querySelectorAll('[data-select]').forEach(btn => {
    btn.addEventListener('click', () => selectPlayer(btn.getAttribute('data-select')));
  });
  leaderboard.querySelectorAll('[data-delete]').forEach(btn => {
    btn.addEventListener('click', () => deletePlayer(btn.getAttribute('data-delete')));
  });

  renderPodium(sorted);
}

function renderPodium(sorted) {
  const podiumContainer = document.getElementById('podium-container');
  podiumContainer.innerHTML = '';
  const top3 = sorted.slice(0,3);
  const podiumOrder = [1,0,2];
  const heights = ['80px','120px','60px'];

  podiumOrder.forEach((idx, position) => {
    const columnDiv = document.createElement('div');
    columnDiv.style.flex = '1';
    columnDiv.style.display = 'flex';
    columnDiv.style.flexDirection = 'column';
    columnDiv.style.alignItems = 'center';
    columnDiv.style.justifyContent = 'flex-end';

    if (top3[idx]) {
      const medalEmoji = position === 0 ? 'ü•à' : position === 1 ? 'ü•á' : 'ü•â';
      columnDiv.innerHTML = `
        <div style="text-align:center;margin-bottom:8px;font-size:32px;line-height:1;">${medalEmoji}</div>
        <div class="w-full rounded-t-lg" style="background:#E10600;height:${heights[position]};"></div>
        <div style="text-align:center;margin-top:8px;font-size:12px;color:#fff;font-weight:bold;word-break:break-word;max-width:80px;">
          ${top3[idx].player_name}
        </div>
      `;
    } else {
      columnDiv.innerHTML = `
        <div class="w-full rounded-t-lg" style="background:#444;height:${heights[position]};"></div>
        <div style="text-align:center;margin-top:8px;font-size:12px;color:#999;">-</div>
      `;
    }
    podiumContainer.appendChild(columnDiv);
  });
}

function updatePlayerSelector() {
  const selector = document.getElementById('player-selector');
  selector.innerHTML = '<option value="">-- Scegli un giocatore --</option>';
  appState.players.forEach(p => {
    const option = document.createElement('option');
    option.value = p.id;
    option.textContent = p.player_name;
    selector.appendChild(option);
  });
}

function initRaceSelector() {
  const selector = document.getElementById('race-selector');
  selector.innerHTML = '<option value="">-- Scegli una gara --</option>';
  raceNames.forEach((name, index) => {
    const option = document.createElement('option');
    option.value = index + 1;
    option.textContent = name;
    selector.appendChild(option);
  });

  selector.addEventListener('change', (e) => {
    currentRace = e.target.value ? parseInt(e.target.value) : null;
    document.getElementById('player-selector').value = '';
    currentPlayer = null;
    updateStartButton();

    if (currentRace) {
      document.getElementById('player-selector').disabled = false;
      document.getElementById('race-scores-container').style.display = 'block';
      document.getElementById('lock-status-container').style.display = 'block';
      document.getElementById('race-events-container').style.display = 'block';
      renderRaceScores();
      renderLockStatus();
      loadRaceEvents();
    } else {
      document.getElementById('player-selector').disabled = true;
      document.getElementById('start-btn').disabled = true;
      document.getElementById('start-btn').style.opacity = '0.5';
      document.getElementById('race-scores-container').style.display = 'none';
      document.getElementById('lock-status-container').style.display = 'none';
      document.getElementById('race-events-container').style.display = 'none';
    }
  });

  document.getElementById('player-selector').addEventListener('change', (e) => {
    const playerId = e.target.value;
    currentPlayer = playerId ? getPlayerById(playerId) : null;
    updateStartButton();
  });
}

function renderRaceScores() {
  const container = document.getElementById('race-scores-list');
  container.innerHTML = '';
  if (!currentRace) return;

  const raceKey = `race_${currentRace}`;
  const raceScores = [];
  appState.players.forEach(player => {
    ensurePlayerDefaults(player);
    const raceData = player.races[raceKey];
    const points = raceData?.points || 0;
    const bingo = raceData?.bingo || false;
    raceScores.push({ playerName: player.player_name, points, bingo });
  });

  raceScores.sort((a,b) => b.points - a.points);

  raceScores.forEach((score, index) => {
    const el = document.createElement('div');
    el.className = 'p-2 rounded font-rajdhani text-white flex justify-between items-center text-sm';
    el.style.background = '#2d3748';
    el.style.border = '1px solid #444';
    let medal = '';
    if (index === 0 && score.points > 0) medal = 'ü•á';
    else if (index === 1 && score.points > 0) medal = 'ü•à';
    else if (index === 2 && score.points > 0) medal = 'ü•â';
    const bingo = score.bingo ? ' ‚≠ê' : '';
    el.innerHTML = `<span>${medal} ${score.playerName}</span><span style="color:#ffd700;font-weight:bold;">* ${score.points}${bingo}</span>`;
    container.appendChild(el);
  });
}

function renderLockStatus() {
  const container = document.getElementById('locks-list');
  container.innerHTML = '';
  if (!currentRace) return;

  const lockStatus = appState.players.map(p => ({
    playerName: p.player_name,
    isLocked: isLockedFor(p, currentRace)
  })).sort((a,b) => a.playerName.localeCompare(b.playerName));

  lockStatus.forEach(lock => {
    const el = document.createElement('div');
    el.className = 'p-2 rounded font-rajdhani text-white flex justify-between items-center text-xs';
    el.style.background = lock.isLocked ? '#1a3a1a' : '#2d3748';
    el.style.border = `1px solid ${lock.isLocked ? '#4a8f4a' : '#444'}`;
    const lockText = lock.isLocked ? 'üîí BLOCCATO' : 'üîì SBLOCCATO';
    el.innerHTML = `<span class="font-bold">${lock.playerName}</span><span>${lockText}</span>`;
    container.appendChild(el);
  });
}

function renderCategoryTabs() {
  const tabsContainer = document.getElementById('category-tabs');
  tabsContainer.innerHTML = '';
  Object.keys(eventCategories).forEach(categoryName => {
    const tab = document.createElement('button');
    tab.className = 'px-3 py-2 rounded font-rajdhani font-bold text-xs transition-all hover:scale-105';
    tab.style.background = currentCategory === categoryName ? '#E10600' : '#2d3748';
    tab.style.color = '#fff';
    tab.style.border = `2px solid ${currentCategory === categoryName ? '#E10600' : '#444'}`;
    tab.textContent = categoryName;
    tab.addEventListener('click', () => {
      currentCategory = categoryName;
      renderCategoryTabs();
      renderEventsList();
    });
    tabsContainer.appendChild(tab);
  });
}

function renderEventsList() {
  const container = document.getElementById('events-container');
  container.innerHTML = '';
  const categoryEvents = eventCategories[currentCategory] || [];

  categoryEvents.forEach(event => {
    const globalIndex = allEvents.indexOf(event);
    const isSelected = selectedIndices.has(globalIndex);
    const el = document.createElement('div');
    el.className = 'rounded cursor-pointer font-rajdhani text-white transition-all flex items-center justify-center';
    el.style.background = isSelected ? '#E10600' : '#2d3748';
    el.style.border = `2px solid ${isSelected ? '#E10600' : '#444'}`;
    el.style.width = '100px';
    el.style.height = '100px';
    el.style.textAlign = 'center';
    el.style.fontSize = '11px';
    el.style.padding = '8px';
    el.style.fontWeight = 'bold';
    el.style.wordWrap = 'break-word';
    el.textContent = event;

    if (selectedIndices.size === 24 && !isSelected) {
      el.style.opacity = '0.5';
      el.style.cursor = 'not-allowed';
      el.style.pointerEvents = 'none';
    } else {
      el.addEventListener('click', () => toggleEvent(globalIndex));
    }
    container.appendChild(el);
  });
}

function toggleEvent(index) {
  if (selectedIndices.has(index)) selectedIndices.delete(index);
  else if (selectedIndices.size < 24) selectedIndices.add(index);
  renderEventsList();
  updatePreview();
}

function updatePreview() {
  const counter = document.getElementById('counter');
  const nextBtn = document.getElementById('next-btn');
  counter.textContent = selectedIndices.size;
  nextBtn.disabled = selectedIndices.size !== 24;
  nextBtn.style.opacity = selectedIndices.size === 24 ? '1' : '0.5';
  nextBtn.style.cursor = selectedIndices.size === 24 ? 'pointer' : 'not-allowed';
}

document.getElementById('random-btn').addEventListener('click', () => {
  selectedIndices.clear();
  const validIndices = Array.from({length: allEvents.length}, (_, i) => i);
  validIndices.sort(() => Math.random() - 0.5).slice(0, 24).forEach(i => selectedIndices.add(i));
  currentCategory = Object.keys(eventCategories)[0];
  renderCategoryTabs();
  renderEventsList();
  updatePreview();
});

function renderCenterEventsList() {
  const container = document.getElementById('center-events-container');
  container.innerHTML = '';
  centerCellEvents.forEach((event, idx) => {
    const isSelected = centerCellIndex === idx;
    const el = document.createElement('div');
    el.className = 'rounded cursor-pointer font-rajdhani text-white transition-all flex items-center justify-center';
    el.style.background = isSelected ? '#ffd700' : '#2d3748';
    el.style.border = `3px solid ${isSelected ? '#ffd700' : '#444'}`;
    el.style.width = '100px';
    el.style.height = '100px';
    el.style.textAlign = 'center';
    el.style.fontSize = '11px';
    el.style.padding = '8px';
    el.style.fontWeight = 'bold';
    el.style.wordWrap = 'break-word';
    el.style.color = isSelected ? '#000' : '#fff';
    el.innerHTML = isSelected ? event + '<br>‚úì' : event;
    el.addEventListener('click', () => selectCenterCell(idx));
    container.appendChild(el);
  });
}

function selectCenterCell(index) {
  centerCellIndex = (centerCellIndex === index) ? null : index;
  renderCenterEventsList();
  updateCenterPreview();
}

function updateCenterPreview() {
  const counter = document.getElementById('center-counter');
  const playBtn = document.getElementById('play-btn');
  counter.textContent = centerCellIndex !== null ? '1' : '0';
  playBtn.disabled = centerCellIndex === null;
  playBtn.style.opacity = centerCellIndex !== null ? '1' : '0.5';
  playBtn.style.cursor = centerCellIndex !== null ? 'pointer' : 'not-allowed';
}

document.getElementById('next-btn').addEventListener('click', () => {
  centerCellIndex = null;
  renderCenterEventsList();
  updateCenterPreview();
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('center-modal').classList.remove('hidden');
});

document.getElementById('back-btn').addEventListener('click', () => {
  document.getElementById('center-modal').classList.add('hidden');
  document.getElementById('modal').classList.remove('hidden');
});

function renderBingoCard() {
  const grid = document.getElementById('bingo-grid');
  grid.innerHTML = '';
  selectedEvents.forEach((event, index) => {
    const cell = document.createElement('div');
    cell.className = 'aspect-square rounded-lg p-2 flex items-center justify-center text-center transition-all font-rajdhani text-sm font-bold';
    cell.style.cursor = isRaceLocked ? 'not-allowed' : 'pointer';
    cell.style.background = markedCells.has(index) ? '#E10600' : '#2d3748';
    cell.style.border = `2px solid ${markedCells.has(index) ? '#E10600' : '#444'}`;
    cell.style.color = '#fff';

    if (index === 12) {
      cell.style.border = '3px solid #ffd700';
      if (markedCells.has(index)) cell.style.boxShadow = '0 0 10px #ffd700';
    }

    cell.textContent = event;
    if (!isRaceLocked) cell.addEventListener('click', () => toggleCell(index));
    grid.appendChild(cell);
  });

  updateScore();
}

function toggleCell(index) {
  if (isRaceLocked) return;
  if (markedCells.has(index)) markedCells.delete(index);
  else markedCells.add(index);

  renderBingoCard();
  renderOtherPlayersCards();
  saveGameDataCurrent();
  checkBingo();
}

function updateScore() {
  document.getElementById('score').textContent = markedCells.size;
}

function checkBingo() {
  if (bingoAchieved) return;
  if (checkBingoStatus(markedCells)) {
    bingoAchieved = true;
    saveGameDataCurrent();
    document.getElementById('bingo-modal').classList.remove('hidden');
  }
}

function updateLockStatusUI() {
  const statusEl = document.getElementById('lock-status');
  const toggleLockBtn = document.getElementById('toggle-lock-btn');
  const toggleUnlockBtn = document.getElementById('toggle-unlock-btn');

  if (isRaceLocked) {
    statusEl.textContent = 'üîí Scelte BLOCCATE per questa gara';
    statusEl.style.color = '#E10600';
    toggleLockBtn.style.display = 'none';
    toggleUnlockBtn.style.display = 'inline-block';
  } else {
    statusEl.textContent = 'üîì Scelte NON bloccate';
    statusEl.style.color = '#FFA500';
    toggleLockBtn.style.display = 'inline-block';
    toggleUnlockBtn.style.display = 'none';
  }
}

/* =========================
   OTHER PLAYERS CARDS
   ========================= */
function renderOtherPlayersCards() {
  const container = document.getElementById('other-players-container');
  container.innerHTML = '';
  if (!currentRace || !currentPlayer) return;

  const raceKey = `race_${currentRace}`;
  const otherPlayers = appState.players.filter(p => p.id !== currentPlayer.id);
  if (otherPlayers.length === 0) return;

  // sort by race points desc
  otherPlayers.sort((a,b) => (b.races?.[raceKey]?.points || 0) - (a.races?.[raceKey]?.points || 0));

  let displayCount = 0;
  otherPlayers.forEach(player => {
    const raceData = player.races?.[raceKey];
    if (!raceData || !Array.isArray(raceData.events) || raceData.events.length !== 25) return;

    const playerEvents = raceData.events;
    const playerMarkedIndices = raceData.marked_indices || [];
    const playerPoints = raceData.points || 0;
    const playerBingo = raceData.bingo || false;
    const playerIsLocked = isLockedFor(player, currentRace);

    const playerCard = document.createElement('div');
    playerCard.style.marginBottom = '1.5rem';
    playerCard.style.padding = '1.5rem';
    playerCard.style.borderRadius = '0.5rem';
    playerCard.style.maxWidth = '600px';
    playerCard.style.width = 'calc(100% - 3rem)';
    playerCard.style.margin = '1.5rem auto';
    playerCard.style.background = '#16213e';
    playerCard.style.border = playerIsLocked ? '2px solid #E10600' : '2px solid #444';

    const medal = displayCount === 0 ? 'ü•á' : displayCount === 1 ? 'ü•à' : displayCount === 2 ? 'ü•â' : '';
    const bingoIcon = playerBingo ? ' ‚≠ê BINGO' : '';
    const lockIcon = playerIsLocked ? ' üîí' : '';

    const titleEl = document.createElement('h3');
    titleEl.className = 'font-orbitron text-xl font-bold text-white mb-4 text-center';
    titleEl.innerHTML = `${medal} ${player.player_name}${lockIcon} <span style="color:#ffd700;">* ${playerPoints}${bingoIcon}</span>`;
    playerCard.appendChild(titleEl);

    const gridContainer = document.createElement('div');
    gridContainer.style.display = 'grid';
    gridContainer.style.gridTemplateColumns = 'repeat(5, 1fr)';
    gridContainer.style.gap = '8px';
    gridContainer.style.marginBottom = '1rem';
    gridContainer.style.maxWidth = '400px';
    gridContainer.style.margin = '0 auto 1rem auto';

    playerEvents.forEach((event, idx) => {
      const cellDiv = document.createElement('div');
      cellDiv.style.aspectRatio = '1 / 1';
      cellDiv.style.borderRadius = '8px';
      cellDiv.style.padding = '8px';
      cellDiv.style.textAlign = 'center';
      cellDiv.style.fontSize = '11px';
      cellDiv.style.color = '#fff';
      cellDiv.style.fontWeight = 'bold';
      cellDiv.style.display = 'flex';
      cellDiv.style.alignItems = 'center';
      cellDiv.style.justifyContent = 'center';
      cellDiv.style.wordWrap = 'break-word';
      cellDiv.style.overflow = 'hidden';

      const isMarked = playerMarkedIndices.includes(idx);
      const isCentre = idx === 12;

      cellDiv.style.background = isMarked ? '#E10600' : '#2d3748';
      cellDiv.style.border = isCentre ? '3px solid #ffd700' : `2px solid ${isMarked ? '#E10600' : '#444'}`;
      cellDiv.style.cursor = playerIsLocked ? 'not-allowed' : 'pointer';
      cellDiv.style.transition = 'all 0.2s ease';
      if (playerIsLocked) cellDiv.style.opacity = '0.7';
      cellDiv.textContent = event;

      if (!playerIsLocked) {
        cellDiv.addEventListener('click', () => {
          const newMarked = new Set(playerMarkedIndices);
          if (newMarked.has(idx)) newMarked.delete(idx);
          else newMarked.add(idx);

          const markedSet = new Set([...newMarked]);
          const updated = {
            ...raceData,
            marked_indices: [...newMarked],
            points: calculatePoints(markedSet),
            bingo: checkBingoStatus(markedSet)
          };
          player.races[raceKey] = updated;
          recomputeTotalPointsForPlayer(player);
          saveState();

          renderRaceScores();
          renderLeaderboard();
          renderOtherPlayersCards();
        });
      }

      gridContainer.appendChild(cellDiv);
    });

    playerCard.appendChild(gridContainer);
    container.appendChild(playerCard);
    displayCount++;
  });
}

/* =========================
   SAVE/LOAD CURRENT GAME
   ========================= */
function saveGameDataCurrent() {
  if (!currentPlayer || !currentRace) return;
  const raceData = {
    points: calculatePoints(markedCells),
    bingo: checkBingoStatus(markedCells),
    events: selectedEvents,
    marked_indices: Array.from(markedCells)
  };
  setRaceData(currentPlayer, currentRace, raceData);
  renderLeaderboard();
  renderRaceScores();
}

function loadGameForPlayerRace(player, raceNumber) {
  const rd = getRaceData(player, raceNumber);
  if (!rd) return false;
  selectedEvents = rd.events || [];
  markedCells = new Set(rd.marked_indices || []);
  bingoAchieved = !!rd.bingo;
  isRaceLocked = isLockedFor(player, raceNumber);
  return true;
}

/* =========================
   RACE EVENTS (ADMIN SIDE)
   ========================= */
function loadRaceEvents() {
  selectedRaceEvents.clear();
  resultsSubmitted = false;

  if (currentRace) {
    const rk = `race_results_${currentRace}`;
    // If ANY player has stored race results, treat as submitted
    for (const p of appState.players) {
      ensurePlayerDefaults(p);
      if (Array.isArray(p.race_results[rk])) {
        selectedRaceEvents = new Set(p.race_results[rk]);
        resultsSubmitted = true;
        break;
      }
    }
  }

  renderRaceEventsList();
}

function renderRaceEventsList() {
  const container = document.getElementById('race-events-list');
  const modeDisplay = document.getElementById('events-mode-display');
  const submitBtn = document.getElementById('submit-results-btn');

  container.innerHTML = '';
  if (!currentRace) return;

  if (resultsSubmitted) {
    modeDisplay.textContent = '‚úÖ Risultati Inviati';
    modeDisplay.style.color = '#4a8f4a';
    submitBtn.style.display = 'none';
  } else {
    modeDisplay.textContent = 'üìù Seleziona gli eventi...';
    modeDisplay.style.color = '#ffd700';
    submitBtn.style.display = 'block';
  }

  allEvents.forEach((event, index) => {
    const isSelected = selectedRaceEvents.has(index);
    const el = document.createElement('div');
    el.className = 'rounded font-rajdhani text-white transition-all p-2 flex items-center justify-between text-sm';
    el.style.background = isSelected ? '#E10600' : '#2d3748';
    el.style.border = `1px solid ${isSelected ? '#E10600' : '#444'}`;
    el.style.cursor = resultsSubmitted ? 'not-allowed' : 'pointer';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = isSelected;
    checkbox.style.marginRight = '8px';
    checkbox.disabled = resultsSubmitted;

    checkbox.addEventListener('change', () => {
      if (isSelected) selectedRaceEvents.delete(index);
      else selectedRaceEvents.add(index);
      renderRaceEventsList();
    });

    el.appendChild(checkbox);
    el.appendChild(document.createTextNode(event));
    container.appendChild(el);
  });
}

document.getElementById('submit-results-btn').addEventListener('click', () => {
  if (!currentRace) return;
  if (selectedRaceEvents.size === 0) {
    notify('Seleziona almeno un evento!');
    return;
  }

  const rk = `race_results_${currentRace}`;
  appState.players.forEach(p => {
    ensurePlayerDefaults(p);
    p.race_results[rk] = Array.from(selectedRaceEvents);
  });
  saveState();

  autoMarkCellsForAllPlayers();
  resultsSubmitted = true;

  renderRaceEventsList();
  renderRaceScores();
  renderOtherPlayersCards();
  renderLeaderboard();

  notify(`‚úÖ Risultati applicati! ${selectedRaceEvents.size} eventi selezionati.`);
});

function autoMarkCellsForAllPlayers() {
  if (!currentRace) return;
  const raceKey = `race_${currentRace}`;

  appState.players.forEach(player => {
    const raceData = player.races?.[raceKey];
    if (!raceData || !Array.isArray(raceData.events)) return;

    const playerEvents = raceData.events;
    const currentMarked = new Set(raceData.marked_indices || []);

    selectedRaceEvents.forEach(selectedIdx => {
      const selectedEvent = allEvents[selectedIdx];
      playerEvents.forEach((ev, idx) => {
        if (ev === selectedEvent) currentMarked.add(idx);
      });
    });

    const markedSet = new Set([...currentMarked]);
    player.races[raceKey] = {
      ...raceData,
      marked_indices: [...currentMarked],
      points: calculatePoints(markedSet),
      bingo: checkBingoStatus(markedSet)
    };

    recomputeTotalPointsForPlayer(player);
  });

  saveState();
}

/* =========================
   ADD / DELETE / RESET
   ========================= */
document.getElementById('add-player-btn').addEventListener('click', () => {
  const input = document.getElementById('new-player-name');
  const name = input.value.trim();
  if (!name) { notify('Inserisci un nome!'); return; }

  const player = {
    id: uid(),
    player_name: name,
    total_points: 0,
    race_locks: {},
    race_results: {},
    races: {}
  };

  appState.players.push(player);
  saveState();
  input.value = '';
  renderLeaderboard();
  updatePlayerSelector();
  notify('‚úÖ Giocatore aggiunto!');
});

function deletePlayer(id) {
  playerToDelete = getPlayerById(id);
  if (!playerToDelete) return;
  document.getElementById('delete-modal').classList.remove('hidden');
}

document.getElementById('confirm-delete-btn').addEventListener('click', () => {
  if (!playerToDelete) return;
  const deletingId = playerToDelete.id;

  deletePlayerById(deletingId);

  if (currentPlayer && currentPlayer.id === deletingId) {
    currentPlayer = null;
    document.getElementById('player-selector').value = '';
    updateStartButton();
    document.getElementById('game-container').classList.add('hidden');
  }

  document.getElementById('delete-modal').classList.add('hidden');
  playerToDelete = null;

  renderLeaderboard();
  updatePlayerSelector();
  renderRaceScores();
  renderLockStatus();
  renderOtherPlayersCards();
});

document.getElementById('cancel-delete-btn').addEventListener('click', () => {
  document.getElementById('delete-modal').classList.add('hidden');
  playerToDelete = null;
});

document.getElementById('reset-season-btn').addEventListener('click', () => {
  document.getElementById('reset-modal').classList.remove('hidden');
});

document.getElementById('confirm-reset-btn').addEventListener('click', () => {
  appState = defaultState();
  saveState();
  currentPlayer = null;
  currentRace = null;
  selectedIndices.clear();
  centerCellIndex = null;
  selectedEvents = [];
  markedCells = new Set();
  bingoAchieved = false;
  isRaceLocked = false;

  document.getElementById('race-selector').value = '';
  document.getElementById('player-selector').value = '';
  document.getElementById('player-selector').disabled = true;
  document.getElementById('race-scores-container').style.display = 'none';
  document.getElementById('lock-status-container').style.display = 'none';
  document.getElementById('race-events-container').style.display = 'none';
  document.getElementById('game-container').classList.add('hidden');

  document.getElementById('reset-modal').classList.add('hidden');

  renderLeaderboard();
  updatePlayerSelector();
  updateStartButton();
  notify('‚úÖ Stagione resettata!');
});

document.getElementById('cancel-reset-btn').addEventListener('click', () => {
  document.getElementById('reset-modal').classList.add('hidden');
});

document.getElementById('close-bingo-btn').addEventListener('click', () => {
  document.getElementById('bingo-modal').classList.add('hidden');
});

document.getElementById('close-notify-btn').addEventListener('click', () => {
  document.getElementById('notify-modal').classList.add('hidden');
});

/* =========================
   LOCK / UNLOCK
   ========================= */
document.getElementById('toggle-lock-btn').addEventListener('click', () => {
  document.getElementById('lock-modal').classList.remove('hidden');
});

document.getElementById('confirm-lock-btn').addEventListener('click', () => {
  document.getElementById('lock-modal').classList.add('hidden');
  if (!currentPlayer || !currentRace) return;

  isRaceLocked = true;
  setLockFor(currentPlayer, currentRace, true);

  updateLockStatusUI();
  renderLockStatus();
  renderOtherPlayersCards();
  notify('üîí Scelte bloccate per questa gara!');
});

document.getElementById('cancel-lock-btn').addEventListener('click', () => {
  document.getElementById('lock-modal').classList.add('hidden');
});

document.getElementById('toggle-unlock-btn').addEventListener('click', () => {
  if (!currentPlayer || !currentRace) return;
  isRaceLocked = false;
  setLockFor(currentPlayer, currentRace, false);

  updateLockStatusUI();
  renderLockStatus();
  renderOtherPlayersCards();
  notify('üîì Scelte sbloccate!');
});

/* =========================
   NEW GAME / PLAY / START
   ========================= */
document.getElementById('new-game-btn').addEventListener('click', () => {
  document.getElementById('game-container').classList.add('hidden');
  selectedIndices.clear();
  centerCellIndex = null;
  currentCategory = Object.keys(eventCategories)[0];
  renderCategoryTabs();
  renderEventsList();
  updatePreview();
  document.getElementById('modal').classList.remove('hidden');
});

document.getElementById('play-btn').addEventListener('click', () => {
  if (!currentPlayer || !currentRace) return;

  selectedEvents = [];
  for (let i = 0; i < allEvents.length; i++) {
    if (selectedIndices.has(i)) selectedEvents.push(allEvents[i]);
  }
  if (centerCellIndex !== null) selectedEvents.splice(12, 0, centerCellEvents[centerCellIndex]);
  selectedEvents = selectedEvents.slice(0, 25);

  markedCells.clear();
  bingoAchieved = false;
  isRaceLocked = isLockedFor(currentPlayer, currentRace);

  document.getElementById('race-title').textContent = raceNames[currentRace - 1];
  document.getElementById('player-display').textContent = `PLAYER: ${currentPlayer.player_name}`;

  renderBingoCard();
  renderOtherPlayersCards();
  updateLockStatusUI();

  document.getElementById('center-modal').classList.add('hidden');
  document.getElementById('game-container').classList.remove('hidden');

  // Save immediately
  saveGameDataCurrent();
});

document.getElementById('start-btn').addEventListener('click', () => {
  if (!currentPlayer || !currentRace) return;

  const loaded = loadGameForPlayerRace(currentPlayer, currentRace);

  if (loaded) {
    document.getElementById('race-title').textContent = raceNames[currentRace - 1];
    document.getElementById('player-display').textContent = `PLAYER: ${currentPlayer.player_name}`;
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('center-modal').classList.add('hidden');
    document.getElementById('game-container').classList.remove('hidden');
    renderBingoCard();
    renderOtherPlayersCards();
    updateLockStatusUI();
    loadRaceEvents();
    return;
  }

  // New selection
  selectedIndices.clear();
  centerCellIndex = null;
  currentCategory = Object.keys(eventCategories)[0];
  renderCategoryTabs();
  renderEventsList();
  updatePreview();
  document.getElementById('game-container').classList.add('hidden');
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('center-modal').classList.add('hidden');
});

function selectPlayer(playerId) {
  const player = getPlayerById(playerId);
  if (!player || !currentRace) return;

  currentPlayer = player;
  document.getElementById('player-selector').value = playerId;
  updateStartButton();

  const loaded = loadGameForPlayerRace(currentPlayer, currentRace);
  if (loaded) {
    document.getElementById('race-title').textContent = raceNames[currentRace - 1];
    document.getElementById('player-display').textContent = `PLAYER: ${currentPlayer.player_name}`;
    document.getElementById('game-container').classList.remove('hidden');
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('center-modal').classList.add('hidden');
    renderBingoCard();
    renderOtherPlayersCards();
    updateLockStatusUI();
    loadRaceEvents();
    renderLeaderboard();
    return;
  }

  selectedIndices.clear();
  centerCellIndex = null;
  currentCategory = Object.keys(eventCategories)[0];
  renderCategoryTabs();
  renderEventsList();
  updatePreview();
  document.getElementById('game-container').classList.add('hidden');
  document.getElementById('center-modal').classList.add('hidden');
  document.getElementById('modal').classList.remove('hidden');
  renderLeaderboard();
}

/* =========================
   INIT
   ========================= */
(function init() {
  // ensure defaults & totals
  appState.players.forEach(p => {
    ensurePlayerDefaults(p);
    recomputeTotalPointsForPlayer(p);
  });
  saveState();

  initRaceSelector();
  updatePlayerSelector();
  renderLeaderboard();
  updateStartButton();

  currentCategory = Object.keys(eventCategories)[0];
})();
</script>
  
<!-- ADMIN BAR (solo per setup, poi puoi lasciarla) -->
<div id="adminBar" style="position:fixed;bottom:12px;right:12px;z-index:9999;display:flex;gap:8px;">
  <button id="btnAdminLogin" style="padding:10px 12px;border-radius:10px;background:#E10600;color:#fff;font-weight:700;border:none;cursor:pointer;">
    Admin login (Google)
  </button>
  <button id="btnShowUid" style="padding:10px 12px;border-radius:10px;background:#2d3748;color:#fff;font-weight:700;border:none;">
    UID: ‚Äî
  </button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCGHO2YKuHU93uMSdAJ4cHUPCOfPADiLoQ",
    authDomain: "f1-bingo-2026-9f795.firebaseapp.com",
    projectId: "f1-bingo-2026-9f795",
    storageBucket: "f1-bingo-2026-9f795.firebasestorage.app",
    messagingSenderId: "373058712857",
    appId: "1:373058712857:web:f7e41be2d61d8dac204188"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // login anonimo automatico per tutti
  await signInAnonymously(auth);

  const btnLogin = document.getElementById("btnAdminLogin");
  const btnUid = document.getElementById("btnShowUid");

  btnLogin.onclick = async () => {
    console.log("Provo login Google‚Ä¶");
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  };

  onAuthStateChanged(auth, (user) => {
    btnUid.textContent = "UID: " + (user?.uid || "‚Äî");
    console.log("ADMIN UID (copia questo):", user?.uid);
  });
</script>

</body>
</html>

